# TA_CATALOG

## 목차
1. 문서 목적 및 프로젝트 매핑
2. 지표/패턴 카탈로그
3. 현재 구현된 것 vs 미구현된 것
4. 피보나치 스윙 선택 개선안
5. 다음 작업 TODO

## 1) 문서 목적 및 프로젝트 매핑
본 문서는 기술적 분석(TA) 항목을 체계화하고, 현재 레포 구조(`app/binance.py`, `app/indicators.py`, `app/scoring.py`, `app/main.py`, `static/app.js`)에 어떻게 매핑할지 정의한다.

- 데이터 소스: Binance OHLCV (`/api/v3/klines`)
- 지표 계산: `app/indicators.py`
- 점수화/확률화: `app/scoring.py` (rule score -> sigmoid)
- API/UI: `app/main.py`, `static/app.js`

---

## 2) 지표/패턴 카탈로그

### 2.1 이동평균 (SMA/EMA)
- 정의: 가격 평균으로 추세 방향과 기울기 확인.
- 계산 개요:
  - SMA(n) = 최근 n개 종가 평균
  - EMA(n): `EMA_t = alpha*close_t + (1-alpha)*EMA_(t-1)`, `alpha=2/(n+1)`
- 대표 파라미터: 20/50/100/200
- 해석(추세/횡보):
  - 추세: 단기 MA > 장기 MA + 기울기 양수(상승), 반대는 하락
  - 횡보: MA 간 거리 축소, 교차 반복
- 장단점/함정: 직관적이나 지연(lag) 큼. 횡보장에서 휩쏘 증가.
- 프로젝트 점수화 반영:
  - `EMA20 > EMA50`면 +w, 반대 -w
  - `abs(EMA20-EMA50)/price`가 작으면 레짐=횡보로 가중치 축소

### 2.2 RSI
- 정의: 상승/하락 강도의 상대적 크기(0~100).
- 계산 개요:
  - `RS = EMA(gain,n)/EMA(loss,n)`
  - `RSI = 100 - 100/(1+RS)`
- 대표 파라미터: 14(기본), 7(민감), 21(완만)
- 해석:
  - 추세장: 40~90(상승), 10~60(하락) 범위 이동
  - 횡보장: 30/70 과매도/과매수 반전 신호 유효성 증가
- 장단점/함정: 강한 추세에서 과매수/과매도 신호 역추세 진입 유도 위험.
- 프로젝트 점수화 반영:
  - 레짐별 다른 임계값 적용(추세장: 35/75, 횡보장: 30/70)

### 2.3 MACD
- 정의: 두 EMA 차이로 모멘텀과 추세 전환 확인.
- 계산 개요:
  - `MACD = EMA(12)-EMA(26)`
  - `Signal = EMA(MACD,9)`
  - `Hist = MACD-Signal`
- 대표 파라미터: (12,26,9)
- 해석:
  - 추세: 0선 상단/하단 유지 중요
  - 횡보: 잦은 교차로 노이즈 증가
- 장단점/함정: 지연형 신호. 횡보장에서 오탐.
- 프로젝트 점수화 반영:
  - hist 부호 + 기울기(증가/감소) 동시 반영

### 2.4 Stochastic
- 정의: 최근 고저 범위 내 종가 위치(모멘텀 오실레이터).
- 계산 개요:
  - `%K = 100*(close-low_n)/(high_n-low_n)`
  - `%D = SMA(%K,3)`
- 대표 파라미터: 14,3,3
- 해석:
  - 추세: 80 이상/20 이하 지속 가능
  - 횡보: 과매수/과매도 반전 정확도 상대적 우수
- 장단점/함정: 단독 사용 시 과민.
- 프로젝트 점수화 반영:
  - RSI와 중복 패널티 적용(동일 계열 오실레이터 과대반영 방지)

### 2.5 Bollinger Bands
- 정의: 이동평균 중심 ± 표준편차 밴드.
- 계산 개요:
  - `mid=SMA(20)`, `upper/lower = mid ± k*std`
- 대표 파라미터: 20, 2.0
- 해석:
  - 추세: 밴드 워크(상단/하단 붙음)
  - 횡보: 상하단 회귀(mean reversion)
- 장단점/함정: squeeze 후 변동성 확대 방향 예측은 별도 신호 필요.
- 프로젝트 점수화 반영:
  - 밴드 위치(pos), 밴드폭(변동성 레짐) 분리 반영

### 2.6 ATR
- 정의: 방향 없는 변동성 크기.
- 계산 개요:
  - `TR=max(high-low, |high-prev_close|, |low-prev_close|)`
  - `ATR = EMA(TR,n)`
- 대표 파라미터: 14
- 해석:
  - 추세/횡보 자체보다 리스크/손절 폭 설정에 유용
- 장단점/함정: 방향 정보 없음.
- 프로젝트 점수화 반영:
  - 변동성 과열 시 confidence 패널티
  - TP/SL 거리 정규화에 사용

### 2.7 ADX (+DI/-DI)
- 정의: 추세 강도(방향 없음), DI로 방향 보조.
- 계산 개요: Wilder DMI 체계 사용.
- 대표 파라미터: 14
- 해석:
  - ADX<20 횡보, >25 추세 강화
- 장단점/함정: 급변 구간 반응 지연.
- 프로젝트 점수화 반영:
  - 레짐 필터 핵심 지표로 우선 도입 권장(P0)

### 2.8 Ichimoku
- 정의: 전환선/기준선/선행스팬으로 추세+균형 가격대 표현.
- 계산 개요:
  - 전환(9), 기준(26), 선행스팬A/B(26 선행)
- 대표 파라미터: 9,26,52
- 해석:
  - 추세: 구름 상단/하단 돌파, 구름 두께로 저항/지지 강도 판단
- 장단점/함정: 구성요소가 많아 과최적화 위험.
- 프로젝트 점수화 반영:
  - 클라우드 상하 위치를 이진 필터로 단순화

### 2.9 거래량 지표 (OBV/CMF/MFI)
- 정의:
  - OBV: 가격 상승/하락에 따른 누적 거래량
  - CMF: 자금 유입/유출(고저종가 위치 가중)
  - MFI: 거래대금 기반 RSI 유사 지표
- 계산 개요: 표준 공식을 사용
- 대표 파라미터: CMF(20), MFI(14)
- 해석:
  - 추세 확인(가격+거래량 동행), 다이버전스 탐지
- 장단점/함정: 거래소별 볼륨 품질 차이.
- 프로젝트 점수화 반영:
  - 모멘텀 신호 확증(confirmation) 가중치로 사용

### 2.10 VWAP
- 정의: 거래량 가중 평균 가격.
- 계산 개요: `VWAP = 누적(price*volume)/누적(volume)` (세션/앵커 기준)
- 대표 파라미터: 세션 VWAP, Anchored VWAP
- 해석:
  - 추세: VWAP 상단 체류=매수 우위
  - 횡보: VWAP 회귀
- 장단점/함정: 24/7 시장에서 세션 정의 중요.
- 프로젝트 점수화 반영:
  - intraday(5m) 트리거에 우선 사용

### 2.11 피보나치(되돌림/확장)
- 정의: 스윙 구간 대비 되돌림/확장 비율.
- 계산 개요:
  - retracement: 0.236/0.382/0.5/0.618/0.786
  - extension: 1.272/1.618/2.0
- 대표 파라미터: 스윙 포인트 정의 규칙(핵심)
- 해석:
  - 추세: 0.382~0.618 반등/저항 관찰
  - 횡보: 단독 신호 신뢰도 낮음
- 장단점/함정: 스윙 선택 임의성.
- 프로젝트 점수화 반영:
  - 레벨 근접도 + 캔들 반응(핀바, 장대음/양봉) 결합 시 점수 부여

### 2.12 다이버전스
- 정의: 가격과 오실레이터(RSI/MACD/OBV) 방향 불일치.
- 계산 개요:
  - 가격 HH인데 지표 LH -> 약세 다이버전스
  - 가격 LL인데 지표 HL -> 강세 다이버전스
- 대표 파라미터: pivot 강도(left/right bars)
- 해석:
  - 추세 후반 경고용으로 유용
- 장단점/함정: 조기신호가 많아 단독 매매 금지.
- 프로젝트 점수화 반영:
  - 반전 단독 진입 금지, 구조 신호(BOS/CHOCH) 동반 시만 가중

### 2.13 지지/저항/구조 (BOS/CHOCH)
- 정의:
  - BOS: 기존 추세 방향으로 구조 돌파
  - CHOCH: 추세 전환 가능성 시사 구조 변화
- 계산 개요: pivot 고점/저점 배열 + 종가 기준 돌파 판정
- 대표 파라미터: pivot 폭, 종가 확정 봉 수
- 해석:
  - 추세: BOS 추종
  - 횡보: range high/low 이탈 실패 주의
- 장단점/함정: 노이즈 구간의 가짜 돌파.
- 프로젝트 점수화 반영:
  - 4h/1h 구조를 필터로, 5m는 트리거로 분리

### 2.14 캔들 패턴
- 정의: 단일/복수 봉 형태로 심리 해석(핀바, 엔골핑, 모닝/이브닝스타 등)
- 계산 개요: 몸통/꼬리 비율과 상대 위치 규칙화
- 대표 파라미터: wick/body 비율 임계값
- 해석:
  - 추세: 눌림 후 반전 캔들 강함
  - 횡보: range 경계에서만 선택적 사용
- 장단점/함정: 문맥 없는 패턴 오탐 많음.
- 프로젝트 점수화 반영:
  - 단독 점수 금지, 레벨(피보/SR/VWAP) 접촉 시만 보너스

### 2.15 주요 차트 패턴
- 정의: 삼각수렴, 채널, 쐐기, H&S, 더블탑/바텀 등
- 계산 개요: pivot 집합 기반 추세선 근사/neckline 돌파 판정
- 대표 파라미터: 최소 터치 횟수, 허용 오차(ATR 기반)
- 해석:
  - 추세: 지속/반전 패턴 구분 필요
  - 횡보: 박스권 패턴 우세
- 장단점/함정: 주관성 큼, 자동화 난이도 높음.
- 프로젝트 점수화 반영:
  - P2에서 패턴 확률 스코어를 별도 feature로 분리

---

## 3) 현재 구현된 것 vs 미구현된 것

### 현재 구현됨
- `app/binance.py`
  - Binance OHLCV 조회, interval 제한(`5m/1h/4h`), TTL 캐시
- `app/indicators.py`
  - EMA20/50, RSI14, MACD(12,26,9), Bollinger(20,2), ATR14, Stochastic(14,3,3)
- `app/scoring.py`
  - 룰 기반 선형 점수 `x` -> sigmoid로 `buy_pct/sell_pct`
  - 이유(reasons) 문자열 반환, confidence(50% 대비 거리)
- `app/main.py`
  - `/api/klines`, `/api/analysis` 제공
- `static/app.js`
  - 캔들 차트 렌더, 분석값 표시
  - 4h에서 단순 피보나치 레벨 표시(최근 N봉 고저점)

### 현재 미구현
- ADX, Ichimoku, OBV/CMF/MFI, VWAP
- 다이버전스 자동 검출
- BOS/CHOCH 구조 인식
- 캔들/차트 패턴 인식
- 멀티 타임프레임 결합 스코어(4h/1h/5m)
- 백테스트/라벨링/성능 리포트 파이프라인
- 피보나치 피벗 기반 스윙 선택(권장안)

---

## 4) 피보나치 스윙 선택 개선안

### A. 최근 N봉 고저점(현재 방식)
- 방법: lookback 구간에서 최고/최저를 스윙으로 채택
- 장점: 구현 단순, 빠름
- 단점: 노이즈/극단값에 취약, 구조 맥락 부재, 스윙 역전 오판 가능
- 적합: UI 보조선, 초간단 MVP

### B. 피벗 기반(권장)
- 방법: `pivot_high(left,right)`, `pivot_low(left,right)`로 유의미한 스윙만 채택 후 최근 유효 고저점 쌍을 구성
- 권장 의사코드:
```text
for i in [left, len-right):
  if high[i] == max(high[i-left:i+right+1]): pivot_high.append(i)
  if low[i]  == min(low[i-left:i+right+1]): pivot_low.append(i)

최근 확정 pivot들에서
상승 스윙: 최근 pivot_low -> 이후 pivot_high
하락 스윙: 최근 pivot_high -> 이후 pivot_low
유효성: 스윙폭 > k * ATR
```
- 장점: 구조 반영, 가짜 극값 감소, 다이버전스/구조분석과 결합 쉬움
- 단점: 확정 지연(right bars), 파라미터 민감
- 권장 파라미터: `left=3~5`, `right=3~5`, `min_swing = 1.0~1.5 * ATR(14)`

---

## 5) 다음 작업 TODO

### P0
- ADX 도입 및 레짐(추세/횡보/고변동) 필터 추가
- 멀티 타임프레임 스코어러 기본 구현(4h 필터, 1h 셋업, 5m 트리거)
- 피보나치 스윙 계산을 피벗 기반으로 교체(기존 단순 방식은 fallback)
- 백테스트 MVP CLI 구축(look-ahead 방지, 수수료/슬리피지 반영)

### P1
- 거래량 지표(OBV/CMF/MFI) + VWAP 추가
- 다이버전스(RSI/MACD) 탐지 및 구조 신호와 결합
- confidence 산출식 개선(레짐 적합도/과열 패널티 포함)

### P2
- Ichimoku, 차트 패턴 인식(삼각/쐐기/더블탑)
- 확장 피보나치(1.272/1.618) 기반 TP 시나리오
- walk-forward/기간 분할 검증 자동화
